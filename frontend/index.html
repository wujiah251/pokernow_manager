<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·å·æ‰‘å…‹æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">â™ </span>
                    <h1>æ‰‘å…‹ä¿±ä¹éƒ¨</h1>
                </div>
                <nav class="nav-tabs">
                    <button
                        v-for="(tab, index) in tabs"
                        :key="index"
                        :class="['nav-tab', { active: currentTab === index }]"
                        @click="currentTab = index"
                    >
                        {{ tab }}
                    </button>
                </nav>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- Tab 1: ç©å®¶æ˜ å°„ -->
            <div v-show="currentTab === 0" class="tab-content">
                <div class="section-header">
                    <h2>ç©å®¶æ˜ å°„</h2>
                    <p class="subtitle">ç©å®¶ ID ä¸æ˜µç§°ã€åˆ«åçš„å¯¹åº”å…³ç³»</p>
                </div>

                <!-- æ–°å¢æ˜ å°„è¡¨å• -->
                <div class="add-player-panel">
                    <h3>æ–°å¢æ˜ å°„</h3>
                    <div class="add-form">
                        <div class="form-group">
                            <label>åˆ«å</label>
                            <input type="text" v-model="newPlayer.alias" placeholder="è¾“å…¥åˆ«å">
                        </div>
                        <div class="form-group">
                            <label>æ˜µç§°</label>
                            <input type="text" v-model="newPlayer.nickname" placeholder="è¾“å…¥æ˜µç§°">
                        </div>
                        <button class="btn btn-primary" @click="addPlayer" :disabled="!newPlayer.alias || !newPlayer.nickname || adding">
                            {{ adding ? 'æ·»åŠ ä¸­...' : 'æ·»åŠ ' }}
                        </button>
                    </div>
                    <div v-if="addResult" :class="['upload-result', addResult.success ? 'success' : 'error']">
                        {{ addResult.message }}
                    </div>
                </div>

                <!-- åˆå¹¶/é‡å‘½åç©å®¶ -->
                <div class="add-player-panel">
                    <h3>åˆå¹¶ç©å®¶</h3>
                    <p class="subtitle">å°†ä¸€ä¸ªç©å®¶çš„æ‰€æœ‰å†å²è®°å½•åˆå¹¶åˆ°å¦ä¸€ä¸ªç©å®¶</p>
                    <div class="add-form">
                        <div class="form-group">
                            <label>åŸæ˜µç§°</label>
                            <select v-model="mergeForm.oldNickname">
                                <option value="">é€‰æ‹©è¦åˆå¹¶çš„ç©å®¶</option>
                                <option v-for="p in playerList" :key="p" :value="p">{{ p }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç›®æ ‡æ˜µç§°</label>
                            <select v-model="mergeForm.newNickname">
                                <option value="">é€‰æ‹©ç›®æ ‡ç©å®¶</option>
                                <option v-for="p in playerList" :key="p" :value="p">{{ p }}</option>
                            </select>
                        </div>
                        <button class="btn btn-warning" @click="mergePlayerData" :disabled="!mergeForm.oldNickname || !mergeForm.newNickname || merging">
                            {{ merging ? 'åˆå¹¶ä¸­...' : 'åˆå¹¶' }}
                        </button>
                    </div>
                    <div v-if="mergeResult" :class="['upload-result', mergeResult.success ? 'success' : 'error']">
                        {{ mergeResult.message }}
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ˜µç§°</th>
                                <th>åˆ«å</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="player in players" :key="player.id">
                                <td class="nickname">{{ player.nickname }}</td>
                                <td class="alias">{{ player.alias || '-' }}</td>
                                <td class="date">{{ formatDate(player.created_at) }}</td>
                                <td>
                                    <button class="btn btn-danger btn-small" @click="deletePlayerMapping(player.nickname)">åˆ é™¤</button>
                                </td>
                            </tr>
                            <tr v-if="players.length === 0">
                                <td colspan="4" class="empty-row">æš‚æ— æ•°æ®</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 2: PnL æŸ¥è¯¢ -->
            <div v-show="currentTab === 1" class="tab-content">
                <div class="section-header">
                    <h2>PnL æŸ¥è¯¢</h2>
                    <p class="subtitle">æ¯æ—¥ç›ˆäºç»Ÿè®¡ä¸ç´¯è®¡æ›²çº¿</p>
                </div>

                <!-- æŸ¥è¯¢æ¡ä»¶ -->
                <div class="query-panel">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <select v-model="selectedDate" @change="loadPnl">
                            <option v-for="date in dates" :key="date" :value="date">{{ date }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç©å®¶ï¼ˆå¯é€‰ï¼‰</label>
                        <select v-model="selectedPlayer" @change="loadPnl">
                            <option value="">å…¨éƒ¨ç©å®¶</option>
                            <option v-for="p in playerList" :key="p" :value="p">{{ p }}</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" @click="loadPnl">æŸ¥è¯¢</button>
                </div>

                <!-- PnL è¡¨æ ¼ -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th @click="toggleSort('date')" class="sortable">
                                    æ—¥æœŸ <span v-if="pnlSortColumn === 'date'">{{ pnlSortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
                                </th>
                                <th @click="toggleSort('player_nickname')" class="sortable">
                                    ç©å®¶ <span v-if="pnlSortColumn === 'player_nickname'">{{ pnlSortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
                                </th>
                                <th @click="toggleSort('total_net')" class="sortable">
                                    å‡€ç›ˆäº <span v-if="pnlSortColumn === 'total_net'">{{ pnlSortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
                                </th>
                                <th @click="toggleSort('cumulative_net')" class="sortable">
                                    ç´¯è®¡ç›ˆäº <span v-if="pnlSortColumn === 'cumulative_net'">{{ pnlSortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="record in sortedPnlRecords" :key="record.id" :class="getPnLClass(record.total_net)">
                                <td>{{ record.date }}</td>
                                <td class="nickname">{{ record.player_nickname }}</td>
                                <td class="pnl-value">{{ formatMoney(record.total_net) }}</td>
                                <td class="pnl-value">{{ pnlCumulative[record.player_nickname] !== undefined ? formatMoney(pnlCumulative[record.player_nickname]) : '-' }}</td>
                            </tr>
                            <!-- åˆè®¡è¡Œ -->
                            <tr v-if="pnlTotal" class="total-row">
                                <td></td>
                                <td class="nickname">{{ pnlTotal.player_nickname }}</td>
                                <td class="pnl-value" :class="getPnLClass(pnlTotal.total_net)">{{ formatMoney(pnlTotal.total_net) }}</td>
                                <td>-</td>
                            </tr>
                            <tr v-if="sortedPnlRecords.length === 0">
                                <td colspan="4" class="empty-row">æš‚æ— æ•°æ®</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ç´¯è®¡æ›²çº¿å›¾ -->
                <div class="chart-section">
                    <h3>ç´¯è®¡ç›ˆäºæ›²çº¿</h3>
                    <div class="chart-query-panel">
                        <div class="form-group">
                            <label>å¼€å§‹æ—¥æœŸ</label>
                            <select v-model="chartStartDate">
                                <option v-for="date in dates" :key="date" :value="date">{{ date }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç»“æŸæ—¥æœŸ</label>
                            <select v-model="chartEndDate">
                                <option v-for="date in dates" :key="date" :value="date">{{ date }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å•ç©å®¶</label>
                            <select v-model="chartPlayer" @change="selectedChartPlayers = []">
                                <option value="">å…¨éƒ¨ç©å®¶</option>
                                <option v-for="p in playerList" :key="p" :value="p">{{ p }}</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" @click="loadChart">æŸ¥è¯¢æ›²çº¿</button>
                    </div>
                    <!-- å¤šé€‰ç©å®¶ -->
                    <div class="multi-select-panel">
                        <label>å¤šé€‰ç©å®¶ï¼ˆæŒ‰ä½Ctrl/Commandå¤šé€‰ï¼‰ï¼š</label>
                        <select multiple v-model="selectedChartPlayers" @change="chartPlayer = ''" style="height: 120px;">
                            <option v-for="p in playerList" :key="p" :value="p">{{ p }}</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <div id="pnlChart" style="width: 100%; height: 400px;"></div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: å¯¹å±€æŸ¥è¯¢ -->
            <div v-show="currentTab === 2" class="tab-content">
                <div class="section-header">
                    <h2>å¯¹å±€æŸ¥è¯¢</h2>
                    <p class="subtitle">æŒ‰æ¡ä»¶ç­›é€‰å¯¹å±€è®°å½•</p>
                </div>
                <div class="coming-soon">
                    <div class="coming-soon-icon">ğŸš§</div>
                    <h3>å¼€å‘ä¸­</h3>
                    <p>è¯¥åŠŸèƒ½æš‚æœªå¼€æ”¾ï¼Œæ•¬è¯·æœŸå¾…...</p>
                </div>
            </div>

            <!-- Tab 4: æ•°æ®ä¸Šä¼  -->
            <div v-show="currentTab === 3" class="tab-content">
                <div class="section-header">
                    <h2>æ•°æ®ä¸Šä¼ </h2>
                    <p class="subtitle">ä¸Šä¼ ç‰Œå±€ CSV æ–‡ä»¶åˆ°æ•°æ®åº“</p>
                </div>

                <div class="upload-panel">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" v-model="uploadDate" class="date-input">
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹© CSV æ–‡ä»¶</label>
                        <div class="file-upload">
                            <input type="file" id="csvFile" accept=".csv" @change="handleFileSelect">
                            <label for="csvFile" class="file-label">
                                <span v-if="selectedFile">{{ selectedFile.name }}</span>
                                <span v-else>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span>
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-primary" @click="uploadFile" :disabled="!selectedFile || !uploadDate || uploading">
                        {{ uploading ? 'ä¸Šä¼ ä¸­...' : 'ä¸Šä¼ ' }}
                    </button>
                </div>

                <div v-if="uploadResult" :class="['upload-result', uploadResult.success ? 'success' : 'error']">
                    {{ uploadResult.message }}
                </div>

                <div class="upload-help">
                    <h4>CSV æ ¼å¼è¦æ±‚</h4>
                    <p>æ–‡ä»¶åº”åŒ…å«ä»¥ä¸‹åˆ—ï¼š</p>
                    <ul>
                        <li>player_nickname - ç©å®¶æ˜µç§°</li>
                        <li>session_start_at - å¼€å§‹æ—¶é—´</li>
                        <li>session_end_at - ç»“æŸæ—¶é—´</li>
                        <li>buy_in - ä¹°å…¥é‡‘é¢</li>
                        <li>buy_out - é€€å‡ºé‡‘é¢</li>
                        <li>stack - å‰©ä½™ç­¹ç </li>
                        <li>net - å‡€ç›ˆäº</li>
                    </ul>
                </div>
            </div>

            <!-- Tab 5: æ•°æ®åˆ é™¤ -->
            <div v-show="currentTab === 4" class="tab-content">
                <div class="section-header">
                    <h2>æ•°æ®åˆ é™¤</h2>
                    <p class="subtitle">åˆ é™¤æŒ‡å®šæ—¥æœŸèŒƒå›´å†…çš„ PnL å’Œå¯¹å±€è®°å½•</p>
                </div>

                <div class="delete-panel">
                    <div class="form-group">
                        <label>å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" v-model="deleteStartDate" class="date-input">
                    </div>
                    <div class="form-group">
                        <label>ç»“æŸæ—¥æœŸ</label>
                        <input type="date" v-model="deleteEndDate" class="date-input">
                    </div>
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" v-model="deletePnl">
                            <span>åˆ é™¤ PnL è®°å½•</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" v-model="deleteLedger">
                            <span>åˆ é™¤å¯¹å±€è®°å½•</span>
                        </label>
                    </div>
                    <button class="btn btn-danger" @click="deleteRecords" :disabled="!canDelete || deleting">
                        {{ deleting ? 'åˆ é™¤ä¸­...' : 'åˆ é™¤' }}
                    </button>
                </div>

                <div v-if="deleteResult" :class="['upload-result', deleteResult.success ? 'success' : 'error']">
                    {{ deleteResult.message }}
                </div>

                <div class="delete-warning">
                    <h4>âš ï¸ å±é™©æ“ä½œè­¦å‘Š</h4>
                    <p>åˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼</p>
                    <ul>
                        <li>åˆ é™¤ PnL è®°å½•å°†æ¸…é™¤æ¯æ—¥æ±‡æ€»æ•°æ®</li>
                        <li>åˆ é™¤å¯¹å±€è®°å½•å°†æ¸…é™¤åŸå§‹å¯¹å±€æ•°æ®</li>
                        <li>å»ºè®®åœ¨åˆ é™¤å‰å¤‡ä»½æ•°æ®åº“</li>
                    </ul>
                </div>
            </div>
        </main>

        <!-- é¡µè„š -->
        <footer class="footer">
            <p>å¾·å·æ‰‘å…‹ 2026 æ˜¥èŠ‚æ•°æ®è®°å½•</p>
        </footer>
    </div>

    <script src="vue.js"></script>
    <script src="echarts.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
